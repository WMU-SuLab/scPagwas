# }
Sys.setenv(R_LOCAL_CACHE = paste0("./", output.dirs, "/scPagwas_cache"))
tt <- Sys.time()
if (is.null(Pagwas)) {
Pagwas <- list()
# class(Pagwas) <- 'Pagwas'
} else if (class(Pagwas) == "Seurat" & is.null(Single_data)) {
Single_data<-Pagwas
Pagwas <- list()
Pagwas<-Single_data@misc
if("scPagwasPaPca" %in% Assays(Single_data)){
Pagwas$pca_scCell_mat<-GetAssayData(Single_data,assay = "scPagwasPaPca")
}
if(assay %in% Assays(Single_data)){
Pagwas$data_mat<-GetAssayData(Single_data,assay = assay)
}else{
stop("Error:assay is not in Pagwas!")
}
if(is.null(Pathway_list)){
stop("Error:Pathway_list should be input!")
}
SOAR::Store(Single_data)
Pagwas$rawPathway_list <- Pathway_list
}else if(class(Pagwas) == "Seurat" & !is.null(Single_data)){
message("Warning:Single_data and Pagwas seruat class are redundant!
we will keep the new Single_data and rerun the Single_data_input and Pathway_pcascore_run function")
Pagwas <- list()
}else if(class(Pagwas) == "list" & is.null(Single_data) & singlecell){
stop("Error:Single_data should be input!, the same as Pagwas")
}else if(class(Pagwas) == "list" & !is.null(Single_data)){
Pagwas$rawPathway_list <- Pathway_list
}else if(class(Pagwas) != "list" ){
stop("Error:The class for Pagwas is wrong! Should be NULL, list or Seurat class.")
}
if (!is.null(Single_data)) {
message(paste(utils::timestamp(quiet = T), " ******* 1st: Single_data_input function start! ********", sep = ""))
tt <- Sys.time()
if (class(Single_data) == "character") {
if (grepl(".rds", Single_data)) {
message("** Start to read the single cell data!")
Single_data <- readRDS(Single_data)
} else {
stop("Error:There is need a data in `.rds` format ")
}
} else if (class(Single_data) != "Seurat") {
stop("Error:There is need a Seurat class for Single_data")
}
if (!assay %in% Assays(Single_data)) {
stop("Error:There is no need assays in your Single_data")
}
if(is.null(Pathway_list)){
stop("Error:Pathway_list should be input!")
}
Pagwas <- Single_data_input(
Pagwas = Pagwas,
assay = assay,
# nfeatures =nfeatures,
Single_data = Single_data,
Pathway_list = Pathway_list,
min_clustercells = min_clustercells
)
Single_data <- Single_data[, colnames(Pagwas$data_mat)]
#save the Single_data
SOAR::Store(Single_data)
message("done!")
cat("Single_data import: ", file = paste0("./", output.dirs, "/scPagwas.run.log"), append = T)
cat(Sys.time() - tt, "\n", file = paste0("./", output.dirs, "/scPagwas.run.log"), append = T)
}}}}}}
dir.create(output.dirs)
Pagwas <- list()
Single_data <- readRDS(Single_data)
Pagwas <- Single_data_input(
Pagwas = Pagwas,
assay = assay,
# nfeatures =nfeatures,
Single_data = Single_data,
Pathway_list = Pathway_list,
min_clustercells = min_clustercells
)
Single_data <- Single_data[, colnames(Pagwas$data_mat)]
Pagwas <- Pathway_pcascore_run(
Pagwas = Pagwas,
Pathway_list = Pathway_list,
min.pathway.size = min.pathway.size,
max.pathway.size = max.pathway.size
)
suppressMessages(gwas_data <- bigreadr::fread2(gwas_data))
Pagwas <- GWAS_summary_input(
Pagwas = Pagwas,
gwas_data = gwas_data,
maf_filter = maf_filter
)
snp_gene_df <- Snp2Gene(snp = Pagwas$gwas_data, refGene = block_annotation, marg = marg)
snp_gene_df$slope <- rep(1, nrow(snp_gene_df))
Pagwas$snp_gene_df <- snp_gene_df[snp_gene_df$Disstance == "0", ]
Pagwas <- Pathway_annotation_input(
Pagwas = Pagwas,
block_annotation = block_annotation
)
Pagwas <- Link_pathway_blocks_gwas(
Pagwas = Pagwas,
chrom_ld = chrom_ld,
split_n = split_n,
singlecell = singlecell,
celltype = celltype,
ncores = ncores
)
Pagwas$lm_results <- Pagwas_perform_regression(Pathway_ld_gwas_data = Pagwas$Pathway_ld_gwas_data)
Pagwas <- Boot_evaluate(Pagwas, bootstrap_iters = iters, part = 0.5)
Pagwas$Pathway_ld_gwas_data <- NULL
Pagwas$Pathway_ld_gwas_data <- NULL
Pagwas <- scPagwas_perform_score(
Pagwas = Pagwas,
remove_outlier = TRUE
)
Pagwas$pca_scCell_mat
head(Pagwas$merge_scexpr)
Pagwas$Pathway_sclm_results
Pagwas_data<-scPagwas_main(Pagwas = NULL,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
output.prefix="test",
output.dirs="scPagwastest_output",
block_annotation = block_annotation,
assay="RNA",
Pathway_list=Genes_by_pathway_kegg,
chrom_ld = chrom_ld,
singlecell=T,
seruat_return=T,
celltype=T,
ncores = 1)
##------ Fri Jul 01 17:17:46 2022 ------##
##------ Fri Jul 01 17:17:50 2022 ------##
##------ Fri Jul 01 17:18:00 2022 ------##
##------ Fri Jul 01 17:18:00 2022 ------##
##------ Fri Jul 01 17:18:00 2022 ------##
##------ Fri Jul 01 17:18:02 2022 ------##
##------ Fri Jul 01 17:18:17 2022 ------##
##------ Fri Jul 01 17:18:18 2022 ------##
##------ Fri Jul 01 17:18:23 2022 ------##
devtools::document()
lintr::lint_package()\
lintr::lint_package()
library(scPagwas)
library(ggplot2)
suppressMessages(library(Seurat))
suppressMessages(library("dplyr"))
#Input pathway gene list, you can construct with youself.
data(Genes_by_pathway_kegg)
#gene annotation files.
data(block_annotation)
#LD data
data(chrom_ld)
#1.start to run the wrapper functions for preprogress.
Pagwas_data<-scPagwas_main(Pagwas = NULL,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
output.prefix="test",
output.dirs="scPagwastest_output",
block_annotation = block_annotation,
assay="RNA",
Pathway_list=Genes_by_pathway_kegg,
chrom_ld = chrom_ld,
singlecell=T,
seruat_return=T,
celltype=T,
ncores = 1)
##------ Fri Jul 01 17:30:47 2022 ------##
##------ Fri Jul 01 17:30:52 2022 ------##
##------ Fri Jul 01 17:31:00 2022 ------##
##------ Fri Jul 01 17:31:00 2022 ------##
##------ Fri Jul 01 17:31:00 2022 ------##
##------ Fri Jul 01 17:31:02 2022 ------##
##------ Fri Jul 01 17:31:30 2022 ------##
##------ Fri Jul 01 17:31:31 2022 ------##
##------ Fri Jul 01 17:31:36 2022 ------##
Bootstrap_P_Barplot(p_results=Pagwas_data@misc$bootstrap_results$bp_value[-1],
p_names=rownames(Pagwas_data@misc$bootstrap_results)[-1],
figurenames = NULL,
width = 5,
height = 7,
do_plot=T,
title = "Test scPagwas")
require("RColorBrewer")
require("Seurat")
require("SeuratObject")
require("ggsci")
#check the objects
DimPlot(Pagwas_data,group.by = "anno",pt.size=1,reduction="umap",label = T, repel=TRUE)+
umap_theme()+ggtitle("Test")+labs(x="TSNE",y="")+theme(aspect.ratio=1)
scPagwas_Visualization(Single_data=Pagwas_data,
p_thre = 0.05,
FigureType = "umap",
width = 7,
height = 7,
lowColor = "white",
highColor = "red",
output.dirs="scPagwastest_output",
size = 0.5,
do_plot = T)
library("RColorBrewer")
library("ggplot2")
scRNAexample$CellsrankPvalue<-Pagwas$CellsrankPvalue[colnames(scRNAexample)]
scRNAexample$positiveCells<-rep(0,ncol(scRNAexample))
scRNAexample$positiveCells[scRNAexample$CellsrankPvalue <= 0.01]<-1
plot_bar_positie_nagtive(seurat_obj=scRNAexample,
var_ident="positiveCells",
var_group="anno",
vec_group_colors=NULL,
f_color=colorRampPalette(brewer.pal(n=10, name="RdYlBu")),
do_plot = T)
Pagwas_data
head(Pagwas_data@meta.data)
Pagwas_data$positiveCells<-rep(0,ncol(Pagwas_data))
Pagwas_data$positiveCells[Pagwas_data$CellScaleqValue <= 0.01]<-1
library("RColorBrewer")
library("ggplot2")
plot_bar_positie_nagtive(seurat_obj=Pagwas_data,
var_ident="positiveCells",
var_group="anno",
vec_group_colors=NULL,
f_color=colorRampPalette(brewer.pal(n=10, name="RdYlBu")),
do_plot = T)
devtools::load_all(".")
plot_bar_positie_nagtive(seurat_obj=Pagwas_data,
var_ident="positiveCells",
var_group="anno",
vec_group_colors=NULL,
f_color=colorRampPalette(brewer.pal(n=10, name="RdYlBu")),
do_plot = T)
plot_bar_positie_nagtive(seurat_obj=Pagwas_data,
var_ident="positiveCells",
var_group="anno",
p_thre = 0.01,
vec_group_colors=NULL,
f_color=colorRampPalette(brewer.pal(n=10, name="RdYlBu")),
do_plot = T)
plot_bar_positie_nagtive(seurat_obj=Pagwas_data,
var_ident="anno",
var_group="positiveCells",
vec_group_colors=c("#E8D0B3","#7EB5A6"),
do_plot = T)
top5genes<-rownames(Pagwas$gene_heritability_correlation)[order(Pagwas$gene_heritability_correlation,decreasing = T)[1:5]]
top5genes<-rownames(Pagwas_data@misc$gene_heritability_correlation)[order(Pagwas_data@misc$gene_heritability_correlation,decreasing = T)[1:5]]
top5genes
plot_vln_Corgenes(seurat_obj=Pagwas_data,
assay="RNA", slot="data",
var_group="anno",
vec_features=top5genes,
vec_group_colors= pal_d3(alpha =0.5)(10),
do_plot = T
)
library(tidyverse)
library("rhdf5")
library(ggplot2)
library(grDevices)
library(stats)
library(FactoMineR)
library(scales)
library(reshape2)
library(ggdendro)
library(grImport2)
library(gridExtra)
library(grid)
library(sisal)
source("E:/RPakage/visulizeplotR/plot_scpathway_contri_dot.R")
plot_scpathway_dot(Pagwas=Pagwas_data,
celltypes=unique(Idents(Pagwas_data))[1:5],
topn_path_celltype=5,
filter_p=0.05,
max_logp=15,
display_max_sizes=F,
size_var ="logrankPvalue" ,
col_var="proportion",
shape.scale = 8,
cols.use=c("lightgrey", "#E45826"),
dend_x_var = "logrankPvalue",
dist_method="euclidean",
hclust_method="ward.D",
do_plot = T,
figurenames = NULL,
width = 7,
height = 7)
source(system.file("extdata", "plot_scpathway_contri_dot.R", package = "scPagwas"))
heritability_cor_scatterplot(gene_heri_cor=Pagwas_data$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=3,
do_plot=T,
#figurenames="E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/test_scatterplot.pdf",
width = 7,
height = 7
)
heritability_cor_scatterplot(gene_heri_cor=Pagwas_data@misc$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=3,
do_plot=T,
#figurenames="E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/test_scatterplot.pdf",
width = 7,
height = 7
)
heritability_cor_scatterplot(gene_heri_cor=Pagwas_data@misc$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=1,
do_plot=T,
#figurenames="E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/test_scatterplot.pdf",
width = 7,
height = 7
)
?heritability_cor_scatterplot
?geom_text_repel
devtools::load_all(".")
heritability_cor_scatterplot(gene_heri_cor=Pagwas_data@misc$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=1,
do_plot=T,
max.overlaps =3,
width = 7,
height = 7)
heritability_cor_scatterplot(gene_heri_cor=Pagwas_data@misc$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=1,
do_plot=T,
max.overlaps =20,
width = 7,
height = 7)
heritability_cor_scatterplot(gene_heri_cor=Pagwas_data@misc$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=2,
do_plot=T,
max.overlaps =50,
width = 7,
height = 7)
heritability_cor_scatterplot(gene_heri_cor=Pagwas_data@misc$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=2,
do_plot=T,
max.overlaps =100000,
width = 7,
height = 7)
devtools::load_all(".")
heritability_cor_scatterplot(gene_heri_cor=Pagwas_data@misc$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=2,
do_plot=T,
max.overlaps =20,
width = 7,
height = 7)
devtools::document()
devtools::document()
library(scPagwas)
devtools::load_all(".")
Pagwas_data<-scPagwas_main(Pagwas = NULL,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
output.prefix="test",
output.dirs="scPagwastest_output",
block_annotation = block_annotation,
assay="RNA",
Pathway_list=Genes_by_pathway_kegg,
chrom_ld = chrom_ld,
singlecell=T,
seruat_return=T,
celltype=T,
ncores = 1)
##------ Fri Jul 01 21:51:55 2022 ------##
##------ Fri Jul 01 21:52:02 2022 ------##
##------ Fri Jul 01 21:52:15 2022 ------##
##------ Fri Jul 01 21:52:15 2022 ------##
##------ Fri Jul 01 21:52:16 2022 ------##
##------ Fri Jul 01 21:52:17 2022 ------##
##------ Fri Jul 01 21:52:34 2022 ------##
##------ Fri Jul 01 21:52:35 2022 ------##
##------ Fri Jul 01 21:52:40 2022 ------##
Pagwas_data
head(Pagwas_data@meta.data)
Bootstrap_P_Barplot(p_results=Pagwas_data@misc$bootstrap_results$bp_value[-1],
p_names=rownames(Pagwas_data@misc$bootstrap_results)[-1],
figurenames = NULL,
width = 5,
height = 7,
do_plot=T,
title = "Test scPagwas")
require("RColorBrewer")
require("Seurat")
require("SeuratObject")
require("ggsci")
#check the objects
DimPlot(Pagwas_data,group.by = "anno",pt.size=1,reduction="umap",label = T, repel=TRUE)+
umap_theme()+ggtitle("Test")+labs(x="TSNE",y="")+theme(aspect.ratio=1)
scPagwas_Visualization(Single_data=Pagwas_data,
p_thre = 0.05,
FigureType = "umap",
width = 7,
height = 7,
lowColor = "white",
highColor = "red",
output.dirs="scPagwastest_output",
size = 0.5,
do_plot = T)
devtools::load_all(".")
require("RColorBrewer")
require("Seurat")
require("SeuratObject")
require("ggsci")
#check the objects
DimPlot(Pagwas_data,group.by = "anno",pt.size=1,reduction="umap",label = T, repel=TRUE)+
umap_theme()+ggtitle("Test")+labs(x="TSNE",y="")+theme(aspect.ratio=1)
scPagwas_Visualization(Single_data=Pagwas_data,
p_thre = 0.05,
FigureType = "umap",
width = 7,
height = 7,
lowColor = "white",
highColor = "red",
output.dirs="scPagwastest_output",
size = 0.5,
do_plot = T)
library("RColorBrewer")
library("ggplot2")
plot_bar_positie_nagtive(seurat_obj=Pagwas_data,
var_ident="positiveCells",
var_group="anno",
p_thre = 0.01,
vec_group_colors=NULL,
f_color=colorRampPalette(brewer.pal(n=10, name="RdYlBu")),
do_plot = T)
plot_bar_positie_nagtive(seurat_obj=Pagwas_data,
var_ident="anno",
var_group="positiveCells",
vec_group_colors=c("#E8D0B3","#7EB5A6"),
do_plot = T)
plot_bar_positie_nagtive(seurat_obj=Pagwas_data,
var_ident="anno",
var_group="positiveCells",
vec_group_colors=c("#E8D0B3","#7EB5A6"),
do_plot = T)
top5genes<-rownames(Pagwas_data@misc$gene_heritability_correlation)[order(Pagwas_data@misc$gene_heritability_correlation,decreasing = T)[1:5]]
plot_vln_Corgenes(seurat_obj=Pagwas_data,
assay="RNA", slot="data",
var_group="anno",
vec_features=top5genes,
vec_group_colors= pal_d3(alpha =0.5)(10),
do_plot = T
)
library(tidyverse)
library("rhdf5")
library(ggplot2)
library(grDevices)
library(stats)
library(FactoMineR)
library(scales)
library(reshape2)
library(ggdendro)
library(grImport2)
library(gridExtra)
library(grid)
library(sisal)
source(system.file("extdata", "plot_scpathway_contri_dot.R", package = "scPagwas"))
plot_scpathway_dot(Pagwas=Pagwas_data,
celltypes=unique(Idents(Pagwas_data))[1:5],
topn_path_celltype=5,
filter_p=0.05,
max_logp=15,
display_max_sizes=F,
size_var ="logrankPvalue" ,
col_var="proportion",
shape.scale = 8,
cols.use=c("lightgrey", "#E45826"),
dend_x_var = "logrankPvalue",
dist_method="euclidean",
hclust_method="ward.D",
do_plot = T,
figurenames = NULL,
width = 7,
height = 7)
heritability_cor_scatterplot(gene_heri_cor=Pagwas_data@misc$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=2,
do_plot=T,
max.overlaps =20,
width = 7,
height = 7)
devtools::document()
devtools::check()
?use_pkgdown
