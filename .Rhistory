##------ Tue Aug 23 20:29:30 2022 ------##
##------ Tue Aug 23 20:29:30 2022 ------##
##------ Tue Aug 23 20:29:31 2022 ------##
##------ Tue Aug 23 20:29:33 2022 ------##
##------ Tue Aug 23 20:30:21 2022 ------##
Pagwas_singlecell<-scPagwas_main(Pagwas =Pagwas_celltypes,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
output.prefix="Test",
output.dirs="Test",
seruat_return=T,
Pathway_list=Genes_by_pathway_kegg,
ncores=1,
assay="RNA",
singlecell=T,
celltype=F,
block_annotation = block_annotation,
chrom_ld = chrom_ld)
##------ Tue Aug 23 20:32:01 2022 ------##
##------ Tue Aug 23 20:32:06 2022 ------##
##------ Tue Aug 23 20:32:07 2022 ------##
##------ Tue Aug 23 20:32:08 2022 ------##
##------ Tue Aug 23 20:32:09 2022 ------##
devtools::load_all(".")
Pagwas_singlecell<-scPagwas_main(Pagwas =Pagwas_celltypes,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
output.prefix="Test",
output.dirs="Test",
seruat_return=T,
Pathway_list=Genes_by_pathway_kegg,
ncores=5,
assay="RNA",
singlecell=T,
celltype=F,
block_annotation = block_annotation,
chrom_ld = chrom_ld)
##------ Tue Aug 23 20:33:28 2022 ------##
##------ Tue Aug 23 20:33:33 2022 ------##
##------ Tue Aug 23 20:33:34 2022 ------##
##------ Tue Aug 23 20:33:35 2022 ------##
##------ Tue Aug 23 20:33:36 2022 ------##
devtools::load_all(".")
Pagwas_celltypes<-scPagwas_main(Pagwas =NULL,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
output.prefix="monocytecount_scPagwas",
output.dirs="monocytecount_bmmc",
Pathway_list=Genes_by_pathway_kegg,
ncores=5,
assay="RNA",
singlecell=F,
celltype=T,
block_annotation = block_annotation,
chrom_ld = chrom_ld)
##------ Tue Aug 23 20:34:32 2022 ------##
##------ Tue Aug 23 20:34:38 2022 ------##
Pagwas_celltypes<-scPagwas_main(Pagwas =NULL,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
output.prefix="Test",
output.dirs="Test",
Pathway_list=Genes_by_pathway_kegg,
ncores=5,
assay="RNA",
singlecell=F,
celltype=T,
block_annotation = block_annotation,
chrom_ld = chrom_ld)
##------ Tue Aug 23 20:34:50 2022 ------##
##------ Tue Aug 23 20:34:56 2022 ------##
##------ Tue Aug 23 20:35:12 2022 ------##
##------ Tue Aug 23 20:35:12 2022 ------##
##------ Tue Aug 23 20:35:13 2022 ------##
##------ Tue Aug 23 20:35:15 2022 ------##
##------ Tue Aug 23 20:35:58 2022 ------##
Pagwas_singlecell<-scPagwas_main(Pagwas =Pagwas_celltypes,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
output.prefix="Test",
output.dirs="Test",
seruat_return=T,
Pathway_list=Genes_by_pathway_kegg,
ncores=5,
assay="RNA",
singlecell=T,
celltype=F,
block_annotation = block_annotation,
chrom_ld = chrom_ld)
##------ Tue Aug 23 20:36:34 2022 ------##
##------ Tue Aug 23 20:36:39 2022 ------##
##------ Tue Aug 23 20:36:40 2022 ------##
##------ Tue Aug 23 20:36:41 2022 ------##
##------ Tue Aug 23 20:36:42 2022 ------##
devtools::load_all(".")
Pagwas_singlecell<-scPagwas_main(Pagwas =NULL,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
output.prefix="Test",
output.dirs="Test",
seruat_return=T,
Pathway_list=Genes_by_pathway_kegg,
ncores=5,
assay="RNA",
singlecell=T,
celltype=F,
block_annotation = block_annotation,
chrom_ld = chrom_ld)
##------ Tue Aug 23 20:39:18 2022 ------##
##------ Tue Aug 23 20:39:22 2022 ------##
##------ Tue Aug 23 20:39:40 2022 ------##
##------ Tue Aug 23 20:39:40 2022 ------##
##------ Tue Aug 23 20:39:41 2022 ------##
##------ Tue Aug 23 20:39:42 2022 ------##
##------ Tue Aug 23 20:40:33 2022 ------##
##------ Tue Aug 23 20:40:41 2022 ------##
scPagwas_Visualization(Single_data=Pagwas_singlecell,
p_thre = 0.05,
FigureType = "umap",
width = 7,
height = 7,
lowColor = "white",
highColor = "red",
output.dirs="figure",
size = 0.5,
do_plot = T)
library(scPagwas)
library(scPagwas)
Pagwas_celltypes<-scPagwas_main(Pagwas =NULL,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
output.prefix="Test",
output.dirs="Test",
Pathway_list=Genes_by_pathway_kegg,
assay="RNA",
singlecell=T,
celltype=T,
block_annotation = block_annotation,
chrom_ld = chrom_ld)
##------ Thu Sep 22 16:32:52 2022 ------##
##------ Thu Sep 22 16:32:58 2022 ------##
##------ Thu Sep 22 16:33:09 2022 ------##
devtools::load_all(".")
library(scPagwas)
Pagwas_celltypes<-scPagwas_main(Pagwas =NULL,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
output.prefix="Test",
output.dirs="Test",
Pathway_list=Genes_by_pathway_kegg,
assay="RNA",
singlecell=T,
celltype=T,
block_annotation = block_annotation,
chrom_ld = chrom_ld)
##------ Thu Sep 22 16:37:30 2022 ------##
##------ Thu Sep 22 16:37:35 2022 ------##
##------ Thu Sep 22 16:37:54 2022 ------##
##------ Thu Sep 22 16:37:55 2022 ------##
##------ Thu Sep 22 16:37:56 2022 ------##
##------ Thu Sep 22 16:37:58 2022 ------##
##------ Thu Sep 22 16:38:46 2022 ------##
##------ Thu Sep 22 16:38:48 2022 ------##
##------ Thu Sep 22 16:38:54 2022 ------##
suppressMessages(gwas_data <- bigreadr::fread2(gwas_data))
suppressMessages(gwas_data <- bigreadr::fread2("system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas")"))
suppressMessages(gwas_data <- bigreadr::fread2("system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas")")
suppressMessages(gwas_data <- bigreadr::fread2("system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"))
suppressMessages(gwas_data <- bigreadr::fread2(system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"))
)
head(gwas_data)
gwas_data<-gwas_data[,c(1,2,3,5,6)]
head(gwas_data)
colnames(gwas_data)[4]<- "stat"
write.table(gwas_data,file = "D:/OneDrive/RPakage/scPagwas/inst/extdata/GWAS_summ_example2.txt")
write.table(gwas_data,file = "D:/OneDrive/RPakage/scPagwas/inst/extdata/GWAS_summ_example2.txt",quote = F,sep = "\t")
Pagwas_celltypes<-scPagwas_main(Pagwas =NULL,
gwas_data =system.file("extdata", "GWAS_summ_example2.txt", package = "scPagwas"),
Single_data =system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
output.prefix="Test",
output.dirs="Test",
Pathway_list=Genes_by_pathway_kegg,
assay="RNA",
singlecell=T,
celltype=T,
block_annotation = block_annotation,
chrom_ld = chrom_ld)
##------ Thu Sep 22 16:45:59 2022 ------##
##------ Thu Sep 22 16:46:05 2022 ------##
##------ Thu Sep 22 16:46:19 2022 ------##
##------ Thu Sep 22 16:46:19 2022 ------##
##------ Thu Sep 22 16:46:20 2022 ------##
##------ Thu Sep 22 16:46:22 2022 ------##
devtools::load_all(".")
Pagwas <- list()
Single_data <- readRDS(system.file("extdata", "scRNAexample.rds", package = "scPagwas"))
Pagwas <- Single_data_input(
Pagwas = Pagwas,
assay = "RNA",
Single_data = Single_data,
Pathway_list = Genes_by_pathway_kegg
)
Single_data <- Single_data[, colnames(Pagwas$data_mat)]
Pagwas <- Pathway_pcascore_run(
Pagwas = Pagwas,
celltype=T,
Pathway_list = Genes_by_pathway_kegg
)
Pagwas <- Pathway_pcascore_run(
Pagwas = Pagwas,
Pathway_list = Genes_by_pathway_kegg
)
gwas_data <- bigreadr::fread2(system.file("extdata", "GWAS_summ_example2.txt", package = "scPagwas"))
Pagwas <- GWAS_summary_input(
Pagwas = Pagwas,
gwas_data = gwas_data,
maf_filter = 0.1
)
head(gwas_data)
gwas_data<-gwas_data[,2:6]
head(gwas_data)
Pagwas <- GWAS_summary_input(
Pagwas = Pagwas,
gwas_data = gwas_data,
maf_filter = 0.1
)
Pagwas$snp_gene_df <- Snp2Gene(snp = Pagwas$gwas_data, refGene = block_annotation, marg = 10000)
head(block_annotation)
write.table(gwas_data,file =  "D:/OneDrive/RPakage/scPagwas/inst/extdata/GWAS_summ_example2.txt",quote = F,sep = "\t",row.names = F)
gwas_data <- bigreadr::fread2(system.file("extdata", "GWAS_summ_example2.txt", package = "scPagwas"))
head(gwas_data)
Pagwas <- Pathway_annotation_input(
Pagwas = Pagwas,
block_annotation = block_annotation
)
names(Pagwas)
Pagwas$pathway_blocks[1:3]
Pagwas <- Link_pathway_blocks_gwas(
Pagwas = Pagwas,
chrom_ld = chrom_ld,
singlecell = T,
celltype = T,
ncores = 1
)
Pagwas$snp_gene_df <- Snp2Gene(snp = Pagwas$gwas_data, refGene = block_annotation, marg = 10000)
head(Pagwas$snp_gene_df)
Pagwas <- Pathway_annotation_input(
Pagwas = Pagwas,
block_annotation = block_annotation
)
names(Pagwas)
Pagwas$pathway_blocks[1:3]
Pagwas$pathway_blocks
Pagwas$pathway_blocks[[1]]
Pagwas <- Link_pathway_blocks_gwas(
Pagwas = Pagwas,
chrom_ld = chrom_ld,
singlecell = T,
celltype = T,
ncores = 1
)
Pachrom_block_list <- lapply(
Pagwas$pathway_blocks,
function(pa_blocks) {
split(pa_blocks,
f = as.vector(pa_blocks$chrom)
)
}
)
names(Pachrom_block_list) <- names(Pagwas$pathway_blocks)
chrom_gwas_list <- lapply(split(Pagwas$gwas_data,
f = Pagwas$gwas_data$chrom
), function(gwas) {
gwas <- data.table::data.table(gwas)
data.table::setkey(gwas, pos)
return(gwas)
})
Pagwas <- Pathway_block_func(
Pagwas = Pagwas,
Pachrom_block_list = Pachrom_block_list,
chrom_ld = chrom_ld,
chrom_gwas_list = chrom_gwas_list,
singlecell = singlecell,
celltype = celltype,
ncores = ncores
)
singlecell=T
celltype= T
ncores=1
Pagwas <- Pathway_block_func(
Pagwas = Pagwas,
Pachrom_block_list = Pachrom_block_list,
chrom_ld = chrom_ld,
chrom_gwas_list = chrom_gwas_list,
singlecell = singlecell,
celltype = celltype,
ncores = ncores
)
Pathway_sclm_results <- list()
Pathway_ld_gwas_data <- list()
SNP_A <- NULL
message(paste0(
"* Start to link gwas and pathway block annotations for ",
length(Pachrom_block_list), " pathways!"
))
names(Pachrom_block_list)
for (pathway in names(Pachrom_block_list)) {
Pa_chrom_block <- Pachrom_block_list[[pathway]]
Pa_chrom_data <- lapply(names(Pa_chrom_block), function(chrom) {
chrom_block <- Pa_chrom_block[[chrom]]
ld_data <- chrom_ld[[chrom]]
data.table::setkey(ld_data, SNP_A) # just in case
if (!(chrom %in% names(chrom_gwas_list))) {
warning(paste(chrom, " for gwas is missing, could be a problem!",
sep = ""
))
return(NULL)
}
if (is.null(chrom_gwas_list[[chrom]])) {
warning(paste(chrom, " data missing, could be a problem", sep = ""))
return(NULL)
}
rsids <- Pagwas$snp_gene_df[which(Pagwas$snp_gene_df$label %in%
chrom_block$label), c("rsid", "label")]
c2 <- chrom_gwas_list[[chrom]]
rsids_gwas <- suppressMessages(dplyr::inner_join(rsids, c2))
if (is.null(nrow(rsids_gwas))) {
return(NULL)
}
if("beta" %in% colnames(rsids_gwas)){
beta_squared <- rsids_gwas$beta^2
}else{
beta_squared <- rsids_gwas$stat^2
}
# again, pretty sure this is binarize data table lookup
sub_ld <- ld_data[.(as.vector(rsids_gwas$rsid)), nomatch = 0L]
return(list(rsids_gwas, beta_squared, sub_ld, chrom_block))
})
# cbind_df代替 rbind_df(list_df)
rm(Pa_chrom_block)
pa_block <- list()
pa_block$block_info <- bigreadr::rbind_df(lapply(
seq_len(length(Pa_chrom_data)),
function(i) Pa_chrom_data[[i]][[4]]
))
pa_block$snps <- bigreadr::rbind_df(lapply(
seq_len(length(Pa_chrom_data)),
function(i) Pa_chrom_data[[i]][[1]]
))
pa_block$y <- unlist(lapply(
seq_len(length(Pa_chrom_data)),
function(i) Pa_chrom_data[[i]][[2]]
))
pa_block$ld_data <- bigreadr::rbind_df(lapply(
seq_len(length(Pa_chrom_data)),
function(i) Pa_chrom_data[[i]][[3]]
))
rsid_x <- intersect(pa_block$snps$rsid, unique(
unlist(pa_block$ld_data[, 1:2])
))
pa_block$ld_data <- as.data.frame(
pa_block$ld_data[pa_block$ld_data$SNP_A
%in% rsid_x & pa_block$ld_data$SNP_B
%in% rsid_x, ]
)
rm(Pa_chrom_data)
if (nrow(pa_block$ld_data) == 0) {
ld_matrix <- diag(1, nrow = nrow(pa_block$snps))
} else {
ld_matrix <- make_ld_matrix(
all_snps = pa_block$snps$rsid,
ld_data = pa_block$ld_data
)
}
pa_block$n_snps <- nrow(pa_block$snps)
pa_block$ld_matrix_squared <- ld_matrix * ld_matrix
## compute the single cell result
if (singlecell) {
Pathway_sclm_results[[pathway]] <- get_Pathway_sclm(
pa_block = pa_block,
pca_scCell_mat = Pagwas$pca_scCell_mat,
data_mat = Pagwas$data_mat,
rawPathway_list = Pagwas$rawPathway_list,
snp_gene_df = Pagwas$snp_gene_df,
ncores = ncores
)
}
if (celltype) {
pa_block <- link_pwpca_block(
pa_block = pa_block,
pca_cell_df = data.matrix(Pagwas$pca_cell_df),
merge_scexpr = Pagwas$merge_scexpr,
snp_gene_df = Pagwas$snp_gene_df,
rawPathway_list = Pagwas$rawPathway_list
)
Pathway_ld_gwas_data[[pathway]] <- pa_block
}
setTxtProgressBar(
pb,
which(names(Pachrom_block_list) == pathway) /
length(names(Pachrom_block_list))
)
}
pathway =  names(Pachrom_block_list)[1]
pathway
Pa_chrom_block <- Pachrom_block_list[[pathway]]
Pa_chrom_block
Pa_chrom_data <- lapply(names(Pa_chrom_block), function(chrom) {
chrom_block <- Pa_chrom_block[[chrom]]
ld_data <- chrom_ld[[chrom]]
data.table::setkey(ld_data, SNP_A) # just in case
if (!(chrom %in% names(chrom_gwas_list))) {
warning(paste(chrom, " for gwas is missing, could be a problem!",
sep = ""
))
return(NULL)
}
if (is.null(chrom_gwas_list[[chrom]])) {
warning(paste(chrom, " data missing, could be a problem", sep = ""))
return(NULL)
}
rsids <- Pagwas$snp_gene_df[which(Pagwas$snp_gene_df$label %in%
chrom_block$label), c("rsid", "label")]
c2 <- chrom_gwas_list[[chrom]]
rsids_gwas <- suppressMessages(dplyr::inner_join(rsids, c2))
if (is.null(nrow(rsids_gwas))) {
return(NULL)
}
if("beta" %in% colnames(rsids_gwas)){
beta_squared <- rsids_gwas$beta^2
}else{
beta_squared <- rsids_gwas$stat^2
}
# again, pretty sure this is binarize data table lookup
sub_ld <- ld_data[.(as.vector(rsids_gwas$rsid)), nomatch = 0L]
return(list(rsids_gwas, beta_squared, sub_ld, chrom_block))
})
Pa_chrom_data
pa_block <- list()
pa_block$block_info <- bigreadr::rbind_df(lapply(
seq_len(length(Pa_chrom_data)),
function(i) Pa_chrom_data[[i]][[4]]
))
pa_block$snps <- bigreadr::rbind_df(lapply(
seq_len(length(Pa_chrom_data)),
function(i) Pa_chrom_data[[i]][[1]]
))
pa_block$y <- unlist(lapply(
seq_len(length(Pa_chrom_data)),
function(i) Pa_chrom_data[[i]][[2]]
))
pa_block$ld_data <- bigreadr::rbind_df(lapply(
seq_len(length(Pa_chrom_data)),
function(i) Pa_chrom_data[[i]][[3]]
))
rsid_x <- intersect(pa_block$snps$rsid, unique(
unlist(pa_block$ld_data[, 1:2])
))
pa_block$ld_data <- as.data.frame(
pa_block$ld_data[pa_block$ld_data$SNP_A
%in% rsid_x & pa_block$ld_data$SNP_B
%in% rsid_x, ]
)
if (nrow(pa_block$ld_data) == 0) {
ld_matrix <- diag(1, nrow = nrow(pa_block$snps))
} else {
ld_matrix <- make_ld_matrix(
all_snps = pa_block$snps$rsid,
ld_data = pa_block$ld_data
)
}
pa_block$n_snps <- nrow(pa_block$snps)
pa_block$ld_matrix_squared <- ld_matrix * ld_matrix
Pathway_sclm_results[[pathway]] <- get_Pathway_sclm(
pa_block = pa_block,
pca_scCell_mat = Pagwas$pca_scCell_mat,
data_mat = Pagwas$data_mat,
rawPathway_list = Pagwas$rawPathway_list,
snp_gene_df = Pagwas$snp_gene_df,
ncores = ncores
)
pa_block
Pagwas$pca_scCell_mat
dim(Pagwas$pca_scCell_mat)
pca_scCell_mat = Pagwas$pca_scCell_mat
data_mat = Pagwas$data_mat
rawPathway_list = Pagwas$rawPathway_list
snp_gene_df = Pagwas$snp_gene_df
pathway <- unique(pa_block$block_info$pathway)
x <- matrix(pca_scCell_mat[pathway, ], nrow = 1)
rownames(x) <- pathway
x
pa_block$n_snps
mg <- intersect(rawPathway_list[[pathway]], rownames(data_mat))
mg
x2 <- biganalytics::apply(data_mat[mg, ], 2, function(ge) {
if (sum(ge) == 0) {
return(rep(0, length(ge)))
} else {
return(ge / sum(ge))
}
})
rownames(x2) <- mg
x2 <- as(x2, "dgCMatrix")
pa_block$n_snps
x2 <- x2[pa_block$snps$label, ]
pa_block$n_snps <- nrow(pa_block$snps)
x <- x[rep(1, pa_block$n_snps), ]
rownames(x) <- pa_block$snps$rsid
x <- x * snp_gene_df[pa_block$snps$rsid, "slope"]
x2 <- x2 * x
pa_block$x <- as(pa_block$ld_matrix_squared %*% x2, "dgCMatrix")
