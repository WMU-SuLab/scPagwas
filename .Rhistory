##------ Wed Mar 16 13:32:44 2022 ------##
##------ Wed Mar 16 13:32:51 2022 ------##
##------ Wed Mar 16 13:33:09 2022 ------##
##------ Wed Mar 16 13:33:09 2022 ------##
##------ Wed Mar 16 13:33:11 2022 ------##
SOAR::Store(gtf_df)
SOAR::Store(block_annotation)
SOAR::Store(scRNAexample)
SOAR::Store(Genes_by_pathway_kegg)
SOAR::Store(chrom_ld)
SOAR::Store(GWAS_summ_example)
message(paste(utils::timestamp(quiet = T), ' ******* 7th: link_pwpca_block function start!! ********',sep = ''))
##------ Wed Mar 16 13:36:04 2022 ------##
#timestart<-Sys.time()
Pagwas <- link_pwpca_block(Pagwas)
message(paste(utils::timestamp(quiet = T), ' ******* 8th: Pagwas_perform_regression function start!! ********',sep = ''))
##------ Wed Mar 16 13:36:09 2022 ------##
Pagwas <- Pagwas_perform_regression(Pagwas, iters = 200,n.cores=1)
names(Pagwas)
message(paste(utils::timestamp(quiet = T), ' ******* 7th: link_scCell_pwpca_block function start!! ********',sep = ''))
##------ Wed Mar 16 13:38:20 2022 ------##
Pagwas <- link_scCell_pwpca_block(Pagwas)
message(paste(utils::timestamp(quiet = T), ' ******* 8th: scPagwas_perform_score function start!! ********',sep = ''))
##------ Wed Mar 16 13:38:35 2022 ------##
Pagwas <- scPagwas_perform_score(Pagwas)
library(Seurat)
library(scPagwas)
library(SOAR)
## basic example code
#Input pathway gene list, you can construct with youself.
data(Genes_by_pathway_kegg)
#Input GWAS summry data(data.frame).
data(GWAS_summ_example)
#gene annotation files.
data(gtf_df)
#Single cell example data.
data(scRNAexample)
CD8+T cell"
Idents(scRNAexample)<-scRNAexample@meta.data$anno
#LD data
data(chrom_ld)
usethis::use_version()
library(Seurat)
library(scPagwas)
library(SOAR)
## basic example code
#Input pathway gene list, you can construct with youself.
data(Genes_by_pathway_kegg)
#Input GWAS summry data(data.frame).
data(GWAS_summ_example)
#gene annotation files.
data(gtf_df)
#Single cell example data.
data(scRNAexample)
#LD data
data(chrom_ld)
##create a session for internal storage
library(Seurat)
library(scPagwas)
library(SOAR)
#Input pathway gene list, you can construct with youself.
data(Genes_by_pathway_kegg)
#Input GWAS summry data(data.frame).
data(GWAS_summ_example)
#gene annotation files.
data(gtf_df)
#Single cell example data.
data(scRNAexample)
#LD data
data(chrom_ld)
Pagwas<-scPagwas_main(Pagwas = NULL,
gwas_data = GWAS_summ_example,
add_eqtls="OnlyTSS",
block_annotation = gtf_df,
Single_data = scRNAexample,
FilterSingleCell=TRUE,
Pathway_list=Genes_by_pathway_kegg,
chrom_ld = chrom_ld,
scPagwasSession="scPagwasSession")
##------ Wed Mar 16 19:12:51 2022 ------##
##------ Wed Mar 16 19:12:51 2022 ------##
##------ Wed Mar 16 19:13:00 2022 ------##
##------ Wed Mar 16 19:13:15 2022 ------##
##------ Wed Mar 16 19:13:16 2022 ------##
##------ Wed Mar 16 19:13:18 2022 ------##
message(paste(utils::timestamp(quiet = T), ' ******* 7th: link_pwpca_block function start!! ********',sep = ''))
##------ Wed Mar 16 19:13:44 2022 ------##
#timestart<-Sys.time()
Pagwas <- link_pwpca_block(Pagwas)
message(paste(utils::timestamp(quiet = T), ' ******* 8th: Pagwas_perform_regression function start!! ********',sep = ''))
##------ Wed Mar 16 19:13:46 2022 ------##
Pagwas <- Pagwas_perform_regression(Pagwas, iters = 200,n.cores=1)
Bootstrap_P_Barplot(Pagwas=Pagwas,title = "Test scPagwas")
Bootstrap_estimate_Plot(Pagwas=Pagwas,figurenames = NULL)
message(paste(utils::timestamp(quiet = T), ' ******* 7th: link_scCell_pwpca_block function start!! ********',sep = ''))
##------ Wed Mar 16 19:14:07 2022 ------##
Pagwas <- link_scCell_pwpca_block(Pagwas)
message(paste(utils::timestamp(quiet = T), ' ******* 8th: scPagwas_perform_score function start!! ********',sep = ''))
##------ Wed Mar 16 19:14:17 2022 ------##
Pagwas <- scPagwas_perform_score(Pagwas)
scPagwas_Visualization(scPagwas_score = Pagwas$scPagwas_score,
Single_data = scRNAexample,
Reduction = TRUE,
assay = "SCT",
cellpercent = 0.1,
filename = "scPagwas_testFigure",
FigureType = "tsne",
width = 7,
height = 7,
lowColor = "#FFBC80", highColor = "#FC4F4F",
size = 1,
title = "scPagwas_score")
message(paste(utils::timestamp(quiet = T), ' ******* 9th:scPagwas_perform_regression function start!! ********',sep = ''))
##------ Wed Mar 16 19:14:39 2022 ------##
Pagwas <- scPagwas_perform_regression(Pagwas)
ls()
library(Seurat)
library(scPagwas)
library(SOAR)
## basic example code
#Input pathway gene list, you can construct with youself.
data(Genes_by_pathway_kegg)
#Input GWAS summry data(data.frame).
data(GWAS_summ_example)
#gene annotation files.
data(gtf_df)
#Single cell example data.
data(scRNAexample)
#LD data
data(chrom_ld)
##create a session for internal storage
scRNAexample
object.size(scRNAexample)
data(Genes_by_pathway_kegg)
#Input GWAS summry data(data.frame).
data(GWAS_summ_example)
#gene annotation files.
data(gtf_df)
#Single cell example data.
data(scRNAexample)
#LD data
data(chrom_ld)
gwas_data = GWAS_summ_example
block_annotation = gtf_df
Single_data = scRNAexample
Pathway_list=Genes_by_pathway_kegg
message("*** Start to store the variables:")
Sys.setenv(R_LOCAL_CACHE=scPagwasSession)
message("*1)gwas_data")
SOAR::Store(gwas_data)
message("*2)block_annotation")
SOAR::Store(block_annotation)
message("*3)Single_data")
SOAR::Store(Single_data)
message("*4)chrom_ld")
SOAR::Store(chrom_ld)
scPagwasSession="scPagwasSession"
scPagwasSession="scPagwasSession"
message("*** Start to store the variables:")
Sys.setenv(R_LOCAL_CACHE=scPagwasSession)
message("*1)gwas_data")
SOAR::Store(gwas_data)
message("*2)block_annotation")
SOAR::Store(block_annotation)
message("*3)Single_data")
SOAR::Store(Single_data)
message("*4)chrom_ld")
SOAR::Store(chrom_ld)
necessary_cols <- c("chrom", "pos", "rsid", "beta", "se", "maf")
# try to control for maf
gwas_data$pos <- as.numeric(gwas_data$pos)
gwas_data$chrom <- paste0("chr", gwas_data$chrom)
gwas_data <- gwas_data[!(gwas_data$chrom %in% "chr23"), ]
gwas_data <- gwas_data[!(gwas_data$chrom %in% "chrX"), ]
gwas_data <- gwas_data[!(gwas_data$chrom %in% "chrY"), ]
gwas_data_6 <- gwas_data %>% dplyr::filter(chrom %in% "chr6") %>%
dplyr::filter(pos > 25000000 & pos < 34000000)
gwas_data <- gwas_data[!(gwas_data$chrom %in% "chr6"), ]
library(dplyr)
gwas_data_6 <- gwas_data %>% dplyr::filter(chrom %in% "chr6") %>%
dplyr::filter(pos > 25000000 & pos < 34000000)
gwas_data <- gwas_data[!(gwas_data$chrom %in% "chr6"), ]
dim(gwas_data)
dim(gwas_data_6)
gwas_data2 <- merge(gwas_data, gwas_data_6)
?merge
gwas_data2 <- merge(gwas_data, gwas_data_6,all = TURE)
gwas_data2 <- merge(gwas_data, gwas_data_6,all = TRUE)
gwas_data_6 <- gwas_data %>% dplyr::filter(chrom %in% "chr6")
gwas_data <- gwas_data[!(gwas_data$chrom %in% "chr6"), ]
head(gwas_data )
gwas_data_6 <- gwas_data %>% dplyr::filter(chrom %in% "chr10")
gwas_data <- gwas_data[!(gwas_data$chrom %in% "chr10"), ]
gwas_data2 <- merge(gwas_data, gwas_data_6,all = TRUE)
object.size(gwas_data )
gwas_data2 <- rbind(gwas_data, gwas_data_6)
object.size(gwas_data2 )
gwas_data3 <- merge(gwas_data, gwas_data_6,all = TRUE)
object.size(gwas_data3 )
?do.call
Pagwas <- GWAS_summary_input(Pagwas=Pagwas,
gwas_data=gwas_data)
Pagwas <- GWAS_summary_input(Pagwas=NULL,
gwas_data=gwas_data)
Pagwas <- Single_data_input(Pagwas=Pagwas,
Single_data=Single_data)
pa_gene <- unique(unlist(Pathway_list))
pana <- names(Pathway_list)[which(unlist(lapply(Pathway_list, function(Pa) length(intersect(Pa, Pagwas$VariableFeatures)))) > 2)]
Pathway_list <- Pathway_list[pana]
# keep the raw pathway
Pagwas$rawPathway_list <- Pathway_list
celltypes<-as.vector(unique(Idents(Single_data)))
pana_list <- lapply(celltypes, function(celltype) {
scCounts <- GetAssayData(object = Single_data[, Idents(Single_data) %in% celltype], slot = "data")
scCounts <- scCounts[rowSums(scCounts) != 0, ]
proper.gene.names <- rownames(scCounts)
pana <- names(Pathway_list)[which(unlist(lapply(Pathway_list, function(Pa) length(intersect(Pa, proper.gene.names)))) > 2)]
return(pana)
})
Pagwas$Pathway_list <- Pathway_list[Reduce(intersect, pana_list)]
Pagwas$rawPathway_list <- Pathway_list[Reduce(intersect, pana_list)]
rm(pana_list)
rm(Pathway_list)
celltype<-celltypes[1]
celltype
?merge_all
#' PathwayPCAtest
#' @description Calculate pca score
#' @param Pathway_list Pathawy gene list(gene symbol),list name is pathway name.
#' @param scCounts single cell Counts pathway
#' @param n.cores Parallel cores,default is 1. use detectCores() to check the cores in computer.
#'
#' @return
#'
PathwayPCAtest <- function(Pathway_list,
scCounts,
n.cores = 1) {
if (any(duplicated(rownames(scCounts)))) {
stop("Duplicate gene names are not allowed - please reduce")
}
if (any(duplicated(colnames(scCounts)))) {
stop("Duplicate cell names are not allowed - please reduce")
}
if (any(is.na(rownames(scCounts)))) {
stop("NA gene names are not allowed - please fix")
}
if (any(is.na(colnames(scCounts)))) {
stop("NA cell names are not allowed - please fix")
}
## filter pathway
nPcs <- 1
scCounts <- t(as.matrix(scCounts))
cm <- Matrix::colMeans(scCounts)
proper.gene.names <- colnames(scCounts)
###### calculate the pca for each pathway terms.
papca <- papply(Pathway_list, function(Pa_id) {
lab <- proper.gene.names %in% intersect(proper.gene.names, Pa_id)
pcs <- irlba::irlba(scCounts[, lab], nv = nPcs, nu = 0, center = cm[lab])
pcs$d <- pcs$d / sqrt(nrow(scCounts))
pcs$rotation <- pcs$v
pcs$v <- NULL
pcs$scores <- as.matrix(t(scCounts[, lab] %*% pcs$rotation) - as.numeric((cm[lab] %*% pcs$rotation)))
cs <- unlist(lapply(seq_len(nrow(pcs$scores)), function(i) sign(cor(pcs$scores[i, ], colMeans(t(scCounts[, lab, drop = FALSE]) * abs(pcs$rotation[, i]))))))
pcs$scores <- pcs$scores * cs
pcs$rotation <- pcs$rotation * cs
rownames(pcs$rotation) <- colnames(scCounts)[lab]
return(list(xp = pcs))
}, n.cores = n.cores)
vdf <- data.frame(do.call(merge,all = TRUE, lapply(seq_along(papca), function(i) {
result <- tryCatch(
{
vars <- as.numeric((papca[[i]]$xp$d))
cbind(i = i, var = vars, n = papca[[i]]$n, npc = seq(seq_len(ncol(papca[[i]]$xp$rotation))))
},
error = function(e) {
return(NULL)
}
)
})))
vscore <- data.frame(do.call(merge,all = TRUE, lapply(seq_along(papca), function(i) {
papca[[i]]$xp$scores
})))
n.cells <- nrow(scCounts)
vdf$exp <- RMTstat::qWishartMax(0.5, n.cells, vdf$n, var = 1, lower.tail = FALSE)
vdf$var <- (vdf$var) / (vdf$exp)
df <- data.frame(name = names(papca)[vdf$i], score = vdf$var, stringsAsFactors = FALSE)
rownames(vscore) <- names(papca)[vdf$i]
colnames(vscore) <- rownames(scCounts)
return(list(df, vscore))
}
n.cores<-1
scPCAscore <- PathwayPCAtest(
Pathway_list = Pagwas$Pathway_list,
scCounts = GetAssayData(object = Single_data[, Idents(Single_data) %in% celltype], slot = "data"),
n.cores = n.cores
)
papply <- function(..., n.cores = detectCores()) {
if (n.cores > 1) {
parallel::mclapply(..., mc.cores = n.cores)
} else {
lapply(...)
}
}
scPCAscore <- PathwayPCAtest(
Pathway_list = Pagwas$Pathway_list,
scCounts = GetAssayData(object = Single_data[, Idents(Single_data) %in% celltype], slot = "data"),
n.cores = n.cores
)
PathwayPCAtest <- function(Pathway_list,
scCounts,
n.cores = 1) {
if (any(duplicated(rownames(scCounts)))) {
stop("Duplicate gene names are not allowed - please reduce")
}
if (any(duplicated(colnames(scCounts)))) {
stop("Duplicate cell names are not allowed - please reduce")
}
if (any(is.na(rownames(scCounts)))) {
stop("NA gene names are not allowed - please fix")
}
if (any(is.na(colnames(scCounts)))) {
stop("NA cell names are not allowed - please fix")
}
## filter pathway
nPcs <- 1
scCounts <- t(as.matrix(scCounts))
cm <- Matrix::colMeans(scCounts)
proper.gene.names <- colnames(scCounts)
###### calculate the pca for each pathway terms.
papca <- papply(Pathway_list, function(Pa_id) {
lab <- proper.gene.names %in% intersect(proper.gene.names, Pa_id)
pcs <- irlba::irlba(scCounts[, lab], nv = nPcs, nu = 0, center = cm[lab])
pcs$d <- pcs$d / sqrt(nrow(scCounts))
pcs$rotation <- pcs$v
pcs$v <- NULL
pcs$scores <- as.matrix(t(scCounts[, lab] %*% pcs$rotation) - as.numeric((cm[lab] %*% pcs$rotation)))
cs <- unlist(lapply(seq_len(nrow(pcs$scores)), function(i) sign(cor(pcs$scores[i, ], colMeans(t(scCounts[, lab, drop = FALSE]) * abs(pcs$rotation[, i]))))))
pcs$scores <- pcs$scores * cs
pcs$rotation <- pcs$rotation * cs
rownames(pcs$rotation) <- colnames(scCounts)[lab]
return(list(xp = pcs))
}, n.cores = n.cores)
vdf <- data.frame(do.call(reshape::merge_all, lapply(seq_along(papca), function(i) {
result <- tryCatch(
{
vars <- as.numeric((papca[[i]]$xp$d))
cbind(i = i, var = vars, n = papca[[i]]$n, npc = seq(seq_len(ncol(papca[[i]]$xp$rotation))))
},
error = function(e) {
return(NULL)
}
)
})))
vscore <- data.frame(do.call(reshape::merge_all, lapply(seq_along(papca), function(i) {
papca[[i]]$xp$scores
})))
n.cells <- nrow(scCounts)
vdf$exp <- RMTstat::qWishartMax(0.5, n.cells, vdf$n, var = 1, lower.tail = FALSE)
vdf$var <- (vdf$var) / (vdf$exp)
df <- data.frame(name = names(papca)[vdf$i], score = vdf$var, stringsAsFactors = FALSE)
rownames(vscore) <- names(papca)[vdf$i]
colnames(vscore) <- rownames(scCounts)
return(list(df, vscore))
}
scPCAscore <- PathwayPCAtest(
Pathway_list = Pagwas$Pathway_list,
scCounts = GetAssayData(object = Single_data[, Idents(Single_data) %in% celltype], slot = "data"),
n.cores = n.cores
)
PathwayPCAtest <- function(Pathway_list,
scCounts,
n.cores = 1) {
if (any(duplicated(rownames(scCounts)))) {
stop("Duplicate gene names are not allowed - please reduce")
}
if (any(duplicated(colnames(scCounts)))) {
stop("Duplicate cell names are not allowed - please reduce")
}
if (any(is.na(rownames(scCounts)))) {
stop("NA gene names are not allowed - please fix")
}
if (any(is.na(colnames(scCounts)))) {
stop("NA cell names are not allowed - please fix")
}
## filter pathway
nPcs <- 1
scCounts <- t(as.matrix(scCounts))
cm <- Matrix::colMeans(scCounts)
proper.gene.names <- colnames(scCounts)
###### calculate the pca for each pathway terms.
papca <- papply(Pathway_list, function(Pa_id) {
lab <- proper.gene.names %in% intersect(proper.gene.names, Pa_id)
pcs <- irlba::irlba(scCounts[, lab], nv = nPcs, nu = 0, center = cm[lab])
pcs$d <- pcs$d / sqrt(nrow(scCounts))
pcs$rotation <- pcs$v
pcs$v <- NULL
pcs$scores <- as.matrix(t(scCounts[, lab] %*% pcs$rotation) - as.numeric((cm[lab] %*% pcs$rotation)))
cs <- unlist(lapply(seq_len(nrow(pcs$scores)), function(i) sign(cor(pcs$scores[i, ], colMeans(t(scCounts[, lab, drop = FALSE]) * abs(pcs$rotation[, i]))))))
pcs$scores <- pcs$scores * cs
pcs$rotation <- pcs$rotation * cs
rownames(pcs$rotation) <- colnames(scCounts)[lab]
return(list(xp = pcs))
}, n.cores = n.cores)
vdf <- data.frame(do.call(rbind, lapply(seq_along(papca), function(i) {
result <- tryCatch(
{
vars <- as.numeric((papca[[i]]$xp$d))
cbind(i = i, var = vars, n = papca[[i]]$n, npc = seq(seq_len(ncol(papca[[i]]$xp$rotation))))
},
error = function(e) {
return(NULL)
}
)
})))
vscore <- data.frame(do.call(rbind, lapply(seq_along(papca), function(i) {
papca[[i]]$xp$scores
})))
n.cells <- nrow(scCounts)
vdf$exp <- RMTstat::qWishartMax(0.5, n.cells, vdf$n, var = 1, lower.tail = FALSE)
vdf$var <- (vdf$var) / (vdf$exp)
df <- data.frame(name = names(papca)[vdf$i], score = vdf$var, stringsAsFactors = FALSE)
rownames(vscore) <- names(papca)[vdf$i]
colnames(vscore) <- rownames(scCounts)
return(list(df, vscore))
}
devtools::document()
devtools::document()
library(Seurat)
library(scPagwas)
library(SOAR)
## basic example code
#Input pathway gene list, you can construct with youself.
data(Genes_by_pathway_kegg)
#Input GWAS summry data(data.frame).
data(GWAS_summ_example)
#gene annotation files.
data(gtf_df)
#Single cell example data.
data(scRNAexample)
#LD data
data(chrom_ld)
Pagwas<-scPagwas_main(Pagwas = NULL,
gwas_data = GWAS_summ_example,
add_eqtls="OnlyTSS",
block_annotation = gtf_df,
Single_data = scRNAexample,
FilterSingleCell=TRUE,
Pathway_list=Genes_by_pathway_kegg,
chrom_ld = chrom_ld,
scPagwasSession="scPagwasSession")
##------ Wed Mar 16 20:20:56 2022 ------##
Pagwas<-scPagwas_main(Pagwas = NULL,
gwas_data = GWAS_summ_example,
add_eqtls="OnlyTSS",
block_annotation = gtf_df,
Single_data = scRNAexample,
FilterSingleCell=TRUE,
Pathway_list=Genes_by_pathway_kegg,
chrom_ld = chrom_ld,
scPagwasSession="scPagwasSession")
##------ Wed Mar 16 20:22:06 2022 ------##
data(Genes_by_pathway_kegg)
#Input GWAS summry data(data.frame).
data(GWAS_summ_example)
#gene annotation files.
data(gtf_df)
#Single cell example data.
data(scRNAexample)
#LD data
data(chrom_ld)
gwas_data = GWAS_summ_example
Pagwas <- GWAS_summary_input(Pagwas=NULL,
gwas_data=gwas_data)
head
head(gwas_data)
class(gwas_data)[1] != "data.frame"
necessary_cols <- c("chrom", "pos", "rsid", "beta", "se", "maf")
# try to control for maf
class(gwas_data$pos)[1]
maf_filter = 0.01
gwas_z_filter = -1
gwas_data$chrom <- paste0("chr", gwas_data$chrom)
!grepl("chr", gwas_data$chrom[1])
gwas_data$chrom[1]
library(Seurat)
library(scPagwas)
library(SOAR)
## basic example code
#Input pathway gene list, you can construct with youself.
data(Genes_by_pathway_kegg)
#Input GWAS summry data(data.frame).
data(GWAS_summ_example)
#gene annotation files.
data(gtf_df)
#Single cell example data.
data(scRNAexample)
#LD data
data(chrom_ld)
##create a session for internal storage
Pagwas<-scPagwas_main(Pagwas = NULL,
gwas_data = GWAS_summ_example,
add_eqtls="OnlyTSS",
block_annotation = gtf_df,
Single_data = scRNAexample,
FilterSingleCell=TRUE,
Pathway_list=Genes_by_pathway_kegg,
chrom_ld = chrom_ld,
scPagwasSession="scPagwasSession")
##------ Wed Mar 16 20:28:18 2022 ------##
gwas_data$chrom
paste0("chr", gwas_data$chrom)
gwas_data$chrom <- paste0("chr", gwas_data$chrom)
