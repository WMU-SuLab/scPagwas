# celltypes="OPC";
# mat_datExpr=Single_data@assays$RNA@data;
# gene_contribution=Pagwas$gene_heritability_correlation;
# Celltype_anno=Pagwas$Celltype_anno;
# Pathway_list=Pagwas$Pathway_list;
# pathwat_select=pathway;
# celltypes="OPC";
# pathways_thre=0.05;
# adjacency.power=4;
# n_max_genes=200;
# n_group=4;
# text_topn=10;
# igraph_algorithm = "drl";
# h_method =c("complete");
# fontface_labels="bold.italic";
# color_edge = "lightblue";
# color_group=pal_d3(alpha =0.5)(10);
# node_alpha=0.6;
# edge_filter=0.001;
# fontSize_label_lg=2;
# fontSize_legend_lg=3;
# fontSize_legend_xlg=3;
# limits=c(0,14);
# range=c(1,5);
# edge_thickness = 2;
# do_plot=F;
# figurenames=NULL;
# width=7;
# height=7;
tt<-Celltype_anno$annotation==celltypes
mat_datExpr_cell<-mat_datExpr[,tt]
#gene_contribution<-gene_contribution[tt]
#names(gene_contribution)<- rownames(vec_gene_contribution)
#pathway_select<-
#
gene_contribution<- gene_contribution[,1]
#names(gene_contribution)<-rownames(vec_gene_contribution)
gene_contribution<- gene_contribution[unique(unlist(Pathway_list[pathwat_select]))]
if(length(gene_contribution)>n_max_genes){
gene_contribution<-gene_contribution[order(gene_contribution,decreasing = T)[1:n_max_genes]]
}
mat_datExpr_cell <- mat_datExpr_cell[names(gene_contribution),]
#distance = dist(data.matrix(mat_datExpr_cell))
pas<-names(sort(gene_contribution,decreasing = T))[text_topn]
#tf<-rep(F,length(gene_contribution))
#tf[which(names(gene_contribution)%in% pas )]<-T
#mydata.hclust = hclust(distance,method = h_method)
#plot(mydata.hclust,hang=-1)
#member = as.character(cutree(mydata.hclust,k = n_group))
#names(member)<-colnames(mat_datExpr_cell)
mat_datExpr_cell<- t(data.matrix(mat_datExpr_cell))
mat_adj <- WGCNA::adjacency(mat_datExpr_cell,
power =adjacency.power,
corFnc = "cor",
corOptions = list(use = "p"),
type = "signed hybrid")
df_hub.data <- cbind.data.frame(pathway = names(gene_contribution), contribution = gene_contribution)
# df_hub.data$color<- member
mat_adj[is.na(mat_adj)]<-0
mat_adj[is.nan(mat_adj)]<-0
mat_adj[which(mat_adj< quantile(mat_adj)[4])]<-0
#mat_adj[ mat_adj< edge_filter]<-0
mat_adj<-mat_adj[rowSums(mat_adj,na.rm = TRUE)!=0,colSums(mat_adj,na.rm = TRUE)!=0]
df_hub.data<-df_hub.data[rownames(mat_adj),]
a<-df_hub.data$contribution*edge_thickness
a[a>limits[2]]<-limits[2]
names(a)<-rownames(mat_adj)
mat_adj %>%
igraph::graph.adjacency(mode = "undirected", weighted = T, diag = FALSE) %>%
tidygraph::as_tbl_graph() %>% igraph::upgrade_graph() %>% tidygraph::activate(nodes) %>%
dplyr::mutate(contribution = a,color=df_hub.data$color) %>%
tidygraph::activate(edges) %>%
tidygraph::activate(nodes) %>%
dplyr::filter(!tidygraph::node_is_isolated())-> hub.plot
hub.plot <- igraph::simplify(hub.plot)
V(hub.plot)$grp <- rep(celltypes,length(V(hub.plot)))
# if(length(E(hub.plot))>10000){
#  bb <-graphlayouts::layout_as_backbone(hub.plot, keep = 0.1)
# }else(
bb <-graphlayouts::layout_as_backbone(hub.plot, keep = 0.4)
# )
#E(hub.plot)$col <- F
#E(hub.plot)$col[bb$backbone] <- T
module.plot<-  ggraph::ggraph(hub.plot, layout = "manual", x = bb$xy[, 1], y = bb$xy[, 2])+
ggraph::geom_edge_link0(aes(edge_width = weight), edge_colour = color_edge) +
ggraph::geom_node_point(aes(fill = grp, size = contribution),
alpha=node_alpha,
shape = 21) +
ggraph::geom_node_text(aes(filter = contribution>= a[pas],
size=fontSize_label_lg,
label = name),repel=T) +
scale_edge_width(range = c(0, 1)) +
scale_size(#breaks = c(1,2,3,4,5,6,7,8,9,10),
limits = limits,
range = range
#labels = c(" \U00B1 1", " \U00B1 2", " \U00B1 3")
)+
ggforce::geom_mark_hull(
aes(x, y, group = grp, fill = grp),
concavity = 4,
expand = unit(2, "mm"),
alpha = 0.15
)+
theme_graph() +
scale_color_manual(values =color_group) +
scale_fill_manual(values =color_group,guide="none")+
ggtitle(paste0(celltypes,"\n",pathwat_select))+
#theme(legend.position = "none")
#theme(legend.position = "bottom")
theme(
legend.title.align=1,
legend.position = "bottom",
legend.margin = margin(0,0,0,0, unit="cm"),
legend.title = element_text(size=fontSize_legend_xlg, face="bold"),
legend.text = element_text(size=fontSize_legend_lg),
legend.spacing.x = unit(0, "cm"),
# margin: top, right, bottom, and left
plot.margin = unit(c(0, 0, 0, 0), "cm"),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
panel.background = element_blank(),
plot.background = element_blank(),
panel.grid = element_blank()
)+theme_graph()
if (do_plot) print(module.plot)
if(!is.null(figurenames)){
pdf(file = figurenames, width = width, height = height)
print(module.plot)
dev.off()
}
}
plot_pathway_contribution_network(mat_datExpr=Single_data@assays$RNA@data, gene_contribution=Pagwas$gene_heritability_correlation,
Celltype_anno=Pagwas$Celltype_anno,
Pathway_list=Pagwas$Pathway_list,
celltypes="OPC",
pathwat_select=pathway,
pathways_thre=0.05,
adjacency.power=4,
n_max_genes=100,
#edge_filter=0.00015,
text_topn=10,
igraph_algorithm = "drl",
h_method = "complete",
fontface_labels="bold.italic",
color_edge = "#9D9D9D",
color_group=pal_d3(alpha =0.5)(5)[ss],
node_alpha=0.8,
fontSize_label_lg=2,
fontSize_legend_lg=3,
fontSize_legend_xlg=3,
limits=c(-0.1,0.1),
edge_thickness = 2,
do_plot=T , #figurenames=paste0("E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/",pathway,"_pthway_network.pdf"),
width=10,
height=10
)
ss<-1
pathway<-pathways[ss]
# library(showtext)
#fond_add('Arial Narrow','/Library/Fonts/ArialNarrow.tiff')
# pdf(paste0("E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/",pathway,"_pthway_network.pdf"))
plot_pathway_contribution_network(mat_datExpr=Single_data@assays$RNA@data, gene_contribution=Pagwas$gene_heritability_correlation,
Celltype_anno=Pagwas$Celltype_anno,
Pathway_list=Pagwas$Pathway_list,
celltypes="OPC",
pathwat_select=pathway,
pathways_thre=0.05,
adjacency.power=4,
n_max_genes=100,
#edge_filter=0.00015,
text_topn=10,
igraph_algorithm = "drl",
h_method = "complete",
fontface_labels="bold.italic",
color_edge = "#9D9D9D",
color_group=pal_d3(alpha =0.5)(5)[ss],
node_alpha=0.8,
fontSize_label_lg=2,
fontSize_legend_lg=3,
fontSize_legend_xlg=3,
limits=c(-0.1,0.1),
range=c(1,7),
edge_thickness = 2,
do_plot=T , #figurenames=paste0("E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/",pathway,"_pthway_network.pdf"),
width=10,
height=10
)
#dev.off()
pathway
ss<-2
pathway<-pathways[ss]
# library(showtext)
#fond_add('Arial Narrow','/Library/Fonts/ArialNarrow.tiff')
# pdf(paste0("E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/",pathway,"_pthway_network.pdf"))
plot_pathway_contribution_network(mat_datExpr=Single_data@assays$RNA@data, gene_contribution=Pagwas$gene_heritability_correlation,
Celltype_anno=Pagwas$Celltype_anno,
Pathway_list=Pagwas$Pathway_list,
celltypes="OPC",
pathwat_select=pathway,
pathways_thre=0.05,
adjacency.power=4,
n_max_genes=100,
#edge_filter=0.00015,
text_topn=10,
igraph_algorithm = "drl",
h_method = "complete",
fontface_labels="bold.italic",
color_edge = "#9D9D9D",
color_group=pal_d3(alpha =0.5)(5)[ss],
node_alpha=0.8,
fontSize_label_lg=2,
fontSize_legend_lg=3,
fontSize_legend_xlg=3,
limits=c(-0.1,0.1),
range=c(1,7),
edge_thickness = 2,
do_plot=T , #figurenames=paste0("E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/",pathway,"_pthway_network.pdf"),
width=10,
height=10
)
#dev.off()
pathway
ss<-3
pathway<-pathways[ss]
# library(showtext)
#fond_add('Arial Narrow','/Library/Fonts/ArialNarrow.tiff')
# pdf(paste0("E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/",pathway,"_pthway_network.pdf"))
plot_pathway_contribution_network(mat_datExpr=Single_data@assays$RNA@data, gene_contribution=Pagwas$gene_heritability_correlation,
Celltype_anno=Pagwas$Celltype_anno,
Pathway_list=Pagwas$Pathway_list,
celltypes="OPC",
pathwat_select=pathway,
pathways_thre=0.05,
adjacency.power=4,
n_max_genes=100,
#edge_filter=0.00015,
text_topn=10,
igraph_algorithm = "drl",
h_method = "complete",
fontface_labels="bold.italic",
color_edge = "#9D9D9D",
color_group=pal_d3(alpha =0.5)(5)[ss],
node_alpha=0.8,
fontSize_label_lg=2,
fontSize_legend_lg=3,
fontSize_legend_xlg=3,
limits=c(-0.1,0.1),
range=c(1,7),
edge_thickness = 2,
do_plot=T , #figurenames=paste0("E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/",pathway,"_pthway_network.pdf"),
width=10,
height=10
)
#dev.off()
pathway
ss<-4
ss
pathway<-pathways[ss]
# library(showtext)
#fond_add('Arial Narrow','/Library/Fonts/ArialNarrow.tiff')
# pdf(paste0("E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/",pathway,"_pthway_network.pdf"))
plot_pathway_contribution_network(mat_datExpr=Single_data@assays$RNA@data, gene_contribution=Pagwas$gene_heritability_correlation,
Celltype_anno=Pagwas$Celltype_anno,
Pathway_list=Pagwas$Pathway_list,
celltypes="OPC",
pathwat_select=pathway,
pathways_thre=0.05,
adjacency.power=4,
n_max_genes=100,
#edge_filter=0.00015,
text_topn=10,
igraph_algorithm = "drl",
h_method = "complete",
fontface_labels="bold.italic",
color_edge = "#9D9D9D",
color_group=pal_d3(alpha =0.5)(5)[ss],
node_alpha=0.8,
fontSize_label_lg=2,
fontSize_legend_lg=3,
fontSize_legend_xlg=3,
limits=c(-0.1,0.1),
range=c(1,7),
edge_thickness = 2,
do_plot=T , #figurenames=paste0("E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/",pathway,"_pthway_network.pdf"),
width=10,
height=10
)
#dev.off()
pathway
ss<-5
pathway<-pathways[ss]
# library(showtext)
#fond_add('Arial Narrow','/Library/Fonts/ArialNarrow.tiff')
# pdf(paste0("E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/",pathway,"_pthway_network.pdf"))
plot_pathway_contribution_network(mat_datExpr=Single_data@assays$RNA@data, gene_contribution=Pagwas$gene_heritability_correlation,
Celltype_anno=Pagwas$Celltype_anno,
Pathway_list=Pagwas$Pathway_list,
celltypes="OPC",
pathwat_select=pathway,
pathways_thre=0.05,
adjacency.power=4,
n_max_genes=100,
#edge_filter=0.00015,
text_topn=10,
igraph_algorithm = "drl",
h_method = "complete",
fontface_labels="bold.italic",
color_edge = "#9D9D9D",
color_group=pal_d3(alpha =0.5)(5)[ss],
node_alpha=0.8,
fontSize_label_lg=2,
fontSize_legend_lg=3,
fontSize_legend_xlg=3,
limits=c(-0.1,0.1),
range=c(1,7),
edge_thickness = 2,
do_plot=T , #figurenames=paste0("E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/",pathway,"_pthway_network.pdf"),
width=10,
height=10
)
#dev.off()
pathway
plot4 <- ggplot(Pagwas_fortify,aes(x =logpValueHigh ,
y =slingPseudotime ))+
geom_point(color="#676FA3",size=0.5)+
geom_smooth(se = F,
color = "#8E0505")+
labs(x = "logpValueHigh",y="slingPseudotime",title=ss)+
theme_classic()+
ggpubr::stat_cor(data =Pagwas_fortify,
method = "spearman")
print(plot4)
pdf("E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/cor_scPagwas_slingPseudotime.pdf")
print(plot4)
dev.off()
print(plot4)
head(Pagwas_fortify)
ggplot(Pagwas_fortify,aes(x=p_thre,y=slingPseudotime,fill=p_thre))+
geom_boxplot(outlier.size = 0.6,alpha=0.6)+ #箱式图异常值大小调整
scale_fill_manual(breaks=c("non","<0.05"), #图例顺序调整
values=c("#9ad3bc","#f3eac2"))+ #填充颜色调整
geom_signif(comparisons=list(c("non","<0.05")),
map_signif_level=c("***"=0.001, "**"=0.01, "*"=0.05), #展示显著性
textsize=2,tip_length=0.03)+
geom_jitter(color="black" ,size=0.89,alpha=0.5)+theme(legend.position="none")+ #不需要图例
theme_ipsum_rc(base_family = "" )+facet_wrap(~Gene,scale="free",ncol=4)
??geom_signif
library(ggpubr)
ggplot(Pagwas_fortify,aes(x=p_thre,y=slingPseudotime,fill=p_thre))+
geom_boxplot(outlier.size = 0.6,alpha=0.6)+ #箱式图异常值大小调整
scale_fill_manual(breaks=c("non","<0.05"), #图例顺序调整
values=c("#9ad3bc","#f3eac2"))+ #填充颜色调整
geom_signif(comparisons=list(c("non","<0.05")),
map_signif_level=c("***"=0.001, "**"=0.01, "*"=0.05), #展示显著性
textsize=2,tip_length=0.03)+
geom_jitter(color="black" ,size=0.89,alpha=0.5)+theme(legend.position="none")+ #不需要图例
theme_ipsum_rc(base_family = "" )+facet_wrap(~Gene,scale="free",ncol=4)
?theme_ipsum_rc
？？theme_ipsum_rc
??theme_ipsum_rc
library(hrbrthemes)
ggplot(Pagwas_fortify,aes(x=p_thre,y=slingPseudotime,fill=p_thre))+
geom_boxplot(outlier.size = 0.6,alpha=0.6)+ #箱式图异常值大小调整
scale_fill_manual(breaks=c("non","<0.05"), #图例顺序调整
values=c("#9ad3bc","#f3eac2"))+ #填充颜色调整
geom_signif(comparisons=list(c("non","<0.05")),
map_signif_level=c("***"=0.001, "**"=0.01, "*"=0.05), #展示显著性
textsize=2,tip_length=0.03)+
geom_jitter(color="black" ,size=0.89,alpha=0.5)+theme(legend.position="none")+ #不需要图例
theme_ipsum_rc(base_family = "" )+facet_wrap(~Gene,scale="free",ncol=4)
ggplot(Pagwas_fortify,aes(x=p_thre,y=slingPseudotime,fill=p_thre))+
geom_boxplot(outlier.size = 0.6,alpha=0.6)+ #箱式图异常值大小调整
scale_fill_manual(breaks=c("non","<0.05"), #图例顺序调整
values=c("#9ad3bc","#f3eac2"))
Pagwas_fortify$p_thre0.01<-rep("non",nrow(Pagwas_fortify))
Pagwas_fortify$p_thre0.01[Pagwas_fortify$pValueHigh<0.01]<-"<0.01"
table(Pagwas_fortify$p_thre0.01)
Pagwas_fortify$p_thre0.001<-rep("non",nrow(Pagwas_fortify))
Pagwas_fortify$p_thre0.001[Pagwas_fortify$pValueHigh<0.001]<-"<0.001"
table(Pagwas_fortify$p_thre0.001)
ggplot(Pagwas_fortify,aes(x=p_thre,y=slingPseudotime,fill=p_thre0.001))+
geom_boxplot(outlier.size = 0.6,alpha=0.6)+ #箱式图异常值大小调整
scale_fill_manual(breaks=c("non","<0.05"), #图例顺序调整
values=c("#9ad3bc","#f3eac2"))
ggplot(Pagwas_fortify,aes(x=p_thre0.001,y=slingPseudotime,fill=p_thre0.001))+
geom_boxplot(outlier.size = 0.6,alpha=0.6)+ #箱式图异常值大小调整
scale_fill_manual(breaks=c("non","<0.05"), #图例顺序调整
values=c("#9ad3bc","#f3eac2"))
heritability_cor_scatterplot(gene_heri_cor=Pagwas$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=3,
do_plot=T,
figurenames="E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/test_scatterplot.pdf",
width = 7,
height = 9
)
heritability_cor_scatterplot<-function(gene_heri_cor=Pagwas$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=3,
do_plot=T,
figurenames=NULL,
width = 7,
height = 7
){
cor_df<-data.frame(genes=rownames(gene_heri_cor),cor=gene_heri_cor[,1],text=rep(NA,nrow(gene_heri_cor)))
cor_df <- cor_df[order(cor_df$cor,decreasing=T),]
cor_df$text[1:topn_genes_label]<-cor_df$genes[1:topn_genes_label]
#save(stage_df1,stage_df2,file="stage_df.RData")
cor_df$order<-1:nrow(cor_df)
p<-ggplot(data = cor_df) +
geom_point(mapping = aes(x = order, y = cor,color=cor))+
scale_colour_gradient2(low = color_low,
mid = color_mid,
high =color_high,
midpoint = 0)+
theme_classic()+ ggrepel::geom_text_repel(aes(x = order, y = cor,label = text), na.rm =T,size = text_size)
if (do_plot) print(p)
if(!is.null(figurenames)){
pdf(file = figurenames, width = width, height = height)
print(p)
dev.off()
}
}
heritability_cor_scatterplot(gene_heri_cor=Pagwas$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=3,
do_plot=T,
figurenames="E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/test_scatterplot.pdf",
width = 7,
height = 9
)
heritability_cor_scatterplot(gene_heri_cor=Pagwas$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=3,
do_plot=T,
figurenames="E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/test_scatterplot.pdf",
width = 7,
height = 7
)
heritability_cor_scatterplot(gene_heri_cor=Pagwas$gene_heritability_correlation,
topn_genes_label=10,
color_low="#035397",
color_high ="#F32424",
color_mid = "white",
text_size=3,
do_plot=T,
figurenames="E:/OneDrive/GWAS_Multiomics/ad_test/5.6test/ad_pruneGSE138852/test_scatterplot.pdf",
width = 7,
height = 7
)
dim(Pagwas$pca_scCell_mat)
gg_pca<-as.data.frame(Pagwas$pca_scCell_mat[,1:100])
gg_pca$pathway<-rownames(gg_pca)
library(reshape2)
gg_pca<-reshape2::melt(gg_pca,id.vars="pathway")
head(gg_pca)
pdf("E:/OneDrive/GWAS_Multiomics/Distribution_test/Pathway_gene_distribution.pdf",width = 4,height = 6)
ggplot(gg_pca, aes(x=value,color=variable))+
geom_density()+
scale_color_brewer(palette="Dark2")+
theme_classic()+
theme(legend.position="top")
dev.off()
pdf("E:/OneDrive/GWAS_Multiomics/Distribution_test/Pathway_gene_distribution.pdf",width = 4,height = 6)
ggplot(gg_pca, aes(x=value,color=variable))+
geom_density()+
scale_color_brewer(palette="Dark2")+
theme_classic()+
theme(legend.position="none")
dev.off()
?scale_color_brewer
pdf("E:/OneDrive/GWAS_Multiomics/Distribution_test/Pathway_gene_distribution.pdf",width = 4,height = 6)
ggplot(gg_pca, aes(x=value,color=variable))+
geom_density()+
scale_color_brewer()+
theme_classic()+
theme(legend.position="none")
dev.off()
Pagwas$data_mat[,1:10]
gg_scgene<-as.data.frame(Pagwas$data_mat[,1:10])
gg_scgene$gene<-rownames(gg_scgene)
#library(reshape2)
gg_scgene<-reshape2::melt(gg_scgene,id.vars="gene")
head(gg_scgene)
pdf("E:/OneDrive/GWAS_Multiomics/Distribution_test/singlegene_distribution.pdf",width = 4,height = 6)
ggplot(gg_scgene, aes(x=value,color=variable))+
geom_density()+
scale_color_brewer()+
theme_classic()+
labs(title="gene")+
theme(legend.position="none")
dev.off()
pdf("E:/OneDrive/GWAS_Multiomics/Distribution_test/Pathway_gene_distribution.pdf",width = 4,height = 6)
ggplot(gg_pca, aes(x=value,color=variable))+
geom_density()+
scale_color_brewer()+
theme_classic()+
labs(title="pathway")+
theme(legend.position="none")
dev.off()
